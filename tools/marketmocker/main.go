// go run market-mocker.go --max=10 --rand 27046bc2-f375-44d8-b769-9c7642305f8a 021dd567-f3ef-47b1-9fca-c5e037f93b42 11551beb-457a-45a9-acb6-7ee493f2d6df 13ac412f-5293-412e-a3f3-e261cd81f08e 0873ee9a-6949-41f9-80a3-1bd393940587 00b36987-0359-4a4b-9f21-3a8fda3aec9e 0797406f-59df-4336-b3cf-e69f96f38cfc 0000ec8b-845b-499a-bea8-50b60e959c8a 2a6bd111-b379-47f9-884e-7bb77f0147cc 4b3b8c19-248e-4a08-9567-2d9600e55923 40ff280b-3b73-4099-ae1a-1d53cfdfb70d 1b597ce5-8a52-46fd-a2b1-a307bd9cc4dc 11e5ddb0-b7de-464e-be6f-f4b9702f17f4 04ca201f-1675-4ef2-a586-bd7abc68c6ad 0da097d7-7e9b-4a0b-893c-221c7afcc9c7 1dea5ba1-bfd2-41ed-9846-895e139e1bfc 368239de-d1fe-4ef4-b3dd-5e30236c4c00 4c37188b-f60b-4a20-b12a-d8da88e88e45 4206663c-9b63-48ba-a484-591342945c28 3ededbab-7203-48d3-9e96-ce2e1e296914 25594844-f750-4909-a95d-23ec55b78a0a 22ea05be-0166-484f-b1b4-f1c8dd80cbf2 2b376281-4c5a-461d-8a11-566289484c4c 1f03e39a-4c14-40c7-be5f-c6c286802156 43d76366-308e-441d-b06d-53c2e891e706 5cf9239e-40e9-45e0-9cc9-fd54bbf1d50c 57b86805-f1d3-4cab-af6c-b4f42b4e9852 406bb42f-0d23-4b1a-a378-f994d7f5a143 2ed3978b-6e02-4fbf-b88f-a082db2d14b1 2f4eaa66-0cae-4750-9d1d-231807ca89bd 32019e6f-1127-4907-9f52-1fc12f531d74 250270ed-5dcc-4541-9c3c-3da858512ada 465ab90e-14c9-4db8-8890-d1d80ec7f293 6e6bbbf1-6c96-46d2-a47f-3d9ca59e4ca0 5842d56b-93ca-4878-a3bc-cad11ae4f248 4245c979-9502-45f6-801b-e94016df711f 38fd6a2f-0497-4671-87b7-83e11c866f2d 44e2d481-eae9-418d-ad22-46743cfdd896 504d0d3b-f147-44e2-88fa-f03741fb963c 2511e25f-9c6c-4db0-9503-ce5dd0f7be7d 545c2dca-4c81-4570-b205-4de38b6b31ef a496a974-9735-4b97-bc1c-071293107fd4 5b6c5579-f3b5-43f4-bf7d-6dfd14644f3e 565da0dc-99bd-4876-be21-4b94ce1152ef 41058f06-15cb-4492-a061-f54e1a62cd99 6c97bc9e-7b75-4d24-9a92-d388cc5866c6 5ca3730f-cb80-4361-bccd-48b8c98660ba 28bf36f7-5a46-44f8-a14b-24a73ca27d7f 54948c9f-3da6-43d3-96f2-7ed6b42ddaf8 db3340f0-6388-4c3d-9726-1be1125f91d4 6b88c12a-a178-4978-bbb6-db56df57263b 6601ef87-1ca5-49b8-be07-34a309b63484 5e1f33b2-1006-4eb5-8c5e-fee22860a4ff 70c5a996-de2c-430d-a215-eb10883b5bee 5cde0a0e-32b7-4fc4-972d-451111d74590 506f44c7-b922-4485-a7ae-977bb4e2a82f 8bb1c251-f4a7-4c43-88c8-d5a7d0b7ff0b e0a7dadc-1299-4658-9cfe-23dab7f95826 727a1805-98f5-47d6-af17-7e46b06addec 7fad2c00-53fd-4aae-b0e3-286d95e71b8f 6093f5f9-c4ca-466f-98c2-3791f21c4198 76a919f2-9f7c-4196-801a-69b5925b5c88 89701acd-8c77-4587-baa4-1caa64d11e22 52ba920b-186d-4f99-90ea-f5c68fbb398c 96c60c69-5be0-4cce-a244-569d5d2e2620 ec4f93be-9764-45dd-a505-e8379ce6171e 7662d89e-7fe0-444c-a885-9419d630e0a2 9c3e8463-f8a6-4143-9b3b-52fdfc822aca 6baf801a-d50b-4972-b4c8-f379e217a063 832058c2-3b5a-4926-b2d5-705ea03204fd 90d343d6-149a-4046-871a-2bd09266b5f3 83f9fcde-a9ef-47c5-b252-fba1e732b112 adfa52f2-27f9-4435-8707-b7160d1950dd f0d0e375-c99a-4701-af68-8f6385760f64 b19d37f6-f07f-479b-812b-8455c44c68db a4add97c-8235-4803-9fdb-8b84ba02cef2 818f3bf4-4459-444e-8077-e78f1a90da75 846a0887-5f43-47b4-a751-5d26325ed9c3 aa540e37-23a8-45cc-ab40-15434fe053f9 84c00eca-b9d8-4bb6-98f5-0d354cee211c c7104198-d723-4839-bca1-264d61971509 f44cfcbb-ed35-44c7-9e33-b0a7c1c92f57 c487e113-0610-4a17-a7ae-fc6c9bb1f61a d343367a-e7c2-4d09-b316-49b07b464527 8cbcdefb-a1d2-40b9-8e07-f6867c08ca79 956775f0-761c-4438-8d2c-317e88602208 ceaca23a-d981-4d13-9071-f09a2759fb5b 85a20cdf-ff6e-48bc-a77a-3e4e3f80b9e6 ccfcceb8-324f-4c78-bb0f-1a5c05e78a6b f4f4aad7-7383-4363-a681-820e59c9fcae ca01eccf-20e4-4c9c-8599-b7b34573cf95 f4ebc720-241c-4e57-9510-0948bf06a868 d42390ba-32ac-44ce-9dd9-a83726049ccd a5dc6934-1b4a-459c-b200-c949fcc5ffc2 ced04e70-db85-4066-b33e-604d42c4a41f 8b65d5f4-1552-4863-8529-c80837691830 d7c73a6b-c608-48a6-befc-5d241dfaaeb1 f50d129a-ef26-4a88-b1cf-915a18981790 d94cfbfd-6d6d-4920-a1e2-c054d29c0c72 fbfd44a3-dd04-47e3-a59a-adb369545a43 da041f27-ebca-4c53-8290-2665f0d1f910 d004148a-e767-4c2c-9d01-f85ddf37367a d6028d75-c540-4246-b0c1-baae476f6e30 8eaf0375-0c73-4dcd-9a38-9d0533a12699 e0c4745b-373e-4499-8a4f-daf28a73a165 ee205b49-f233-4be6-831f-a0092b154d89 fd6f1fa6-cedd-4aa3-a5cd-19b72945f17f e25b609b-88f7-409d-b3db-fa6e1c244b24 ed41f894-be7a-4b8d-a710-a697d32d92cd dac7578b-c046-47b8-9954-a299429e7f7d e3183b04-4912-4eac-8588-3d1c2ce312fa 8fc9325c-7e8e-4f88-a948-19a1f449b3d7 f01a0a69-d1c9-4cb2-8690-62395a2cf434 e886b07b-2fff-4586-965a-726ee0d8ea7d fe4aebca-118e-459f-8fa9-25405903ab89 e520f5ad-2f71-48ed-bb07-c2aa3fb4f0ce 9290915a-07d2-4228-a9eb-305b4a01ba4c de108cc1-f7a2-41d0-a1ac-1ef8f6d85c2a fa0ab804-119f-44c3-a0ce-4c1e007c379f fa22d232-1077-4362-810e-e8c744d08ed1 9c816bd6-6aa8-4c4c-8cd2-f35f3b5ae458 e8adf96c-92c5-4ab9-997b-4ee7cb401cb7 9cb67949-c611-40b1-9f2c-3d1a8d035192 9e722c7d-31cb-4e37-bbf2-ad304b3372b1 a755d9d1-f1b5-44ad-a86c-803ec1e9d561 a84daf58-ec27-4c50-a999-e12bec83bf6f b9e98815-f7e5-4c04-b8f8-d43e8be4fc05 cdb1369b-9c19-4ea5-bb20-6678db7dfbc3 d265a8f5-636a-4831-9e92-ae1c2d69e3e2 e3ad96fe-be41-4274-aa8f-b51b1c0f43d1

package main

import (
	"encoding/json"
	"flag"
	"fmt"
	"io"
	"math/rand"
	"net/http"
	"strings"
	"sync"
	"time"
)

type Env struct {
	url   string
	token string
}

var (
	env Env

	envs = map[string]Env{
		"local": {
			"http://localhost:8000/my/markets",
			"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySUQiOiIxNmE2OWUyOC1mMjBiLTQ0NzUtYjIxNC1hZGVhNmZjZTA3MTkiLCJMZXZlbCI6IiIsImV4cCI6MTU5ODU0MjcyMX0.yn-Xrh3UblPbslcq1bRKiuUPjPuSYF2EZYe852hbIwM",
		},
		"dev": {
			"https://api.dotagiftx.com/my/markets",
			"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJVc2VySUQiOiJjNzUwMDkyMi1lNTE2LTQ0MzgtYjQyZS04ZDk3ZTNhMDZmOTQiLCJMZXZlbCI6IiIsImV4cCI6MTU5NzQ4MDE2OX0.hVsus9JYmeRhy_8rJ11hRQ1VrrF6zSQ02WhVCCEBomw",
		},
	}
)

type Payload struct {
	ItemID string  `json:"item_id"`
	Price  float64 `json:"price"`
}

func main() {
	envPtr := flag.String("env", "local", "environment")
	maxPtr := flag.Int("max", 10, "maximum entries")
	randPtr := flag.Bool("rand", false, "randomize size and amount values")
	flag.Parse()

	uuids := flag.Args()
	if len(uuids) == 0 {
		fmt.Println("product uuid required")
		return
	}

	env = envs[*envPtr]
	fmt.Println(env.url)

	var wg sync.WaitGroup
	wg.Add(len(uuids))
	for _, uuid := range uuids {
		go func(uuid string) {
			defer wg.Done()
			process(uuid, *maxPtr, *randPtr)
		}(uuid)
	}
	wg.Wait()
}

func process(uuid string, max int, rand bool) {
	payload := Payload{
		ItemID: uuid,
	}

	for i := 0; i < max; i++ {
		p := payload
		if rand {
			randPayload(i, &p)
		} else {
			seqPayload(i, &p)
		}

		if err := postMarket(p); err != nil {
			fmt.Println("could not post market:", err)
		}
	}
}

func processConcurrent(uuid string, max int, rand bool) {
	payload := Payload{
		ItemID: uuid,
	}

	var wg sync.WaitGroup
	wg.Add(max)
	for i := 0; i < max; i++ {
		go func(ctr int, p Payload) {
			defer wg.Done()

			if rand {
				randPayload(ctr, &p)
			} else {
				seqPayload(ctr, &p)
			}

			if err := postMarket(p); err != nil {
				fmt.Println("could not post market:", err)
			}
		}(i, payload)
	}
	wg.Wait()
}

func seqPayload(ctr int, p *Payload) (typ string) {
	p.Price += float64(ctr%10*10) + 1
	return
}

func randPayload(ctr int, p *Payload) (typ string) {
	rand.Seed(time.Now().UnixNano() + int64(ctr))
	// randomize values
	p.Price += float64(rand.Intn(10000))/100 + 1
	return
}

func postMarket(p Payload) error {
	bs := time.Now()
	payload, err := json.Marshal(&p)
	if err != nil {
		return err
	}
	sp := string(payload)

	client := &http.Client{}
	method := "POST"
	req, err := http.NewRequest(method, env.url, strings.NewReader(sp))
	if err != nil {
		return err
	}
	req.Header.Add("Content-Type", "application/json")
	req.Header.Add("Authorization", "Bearer "+env.token)

	res, err := client.Do(req)
	if err != nil {
		return err
	}
	defer res.Body.Close()
	str, err := io.ReadAll(res.Body)
	if err != nil {
		return err
	}
	if res.StatusCode >= 400 {
		err = fmt.Errorf(string(str))
	}

	be := time.Now()
	fmt.Println(res.StatusCode, p.ItemID, "\t", be.Sub(bs), "\t\tamt", p.Price)
	return err
}
